<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeautyBooker - Gestione Appuntamenti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        body.modal-open {
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
        }

        .plan-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            align-items: start;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .sidebar h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            color: #666;
        }

        .nav-item:hover, .nav-item.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }
        
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .stats-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-label {
            color: #666;
            font-size: 14px;
        }

        .quick-actions h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .action-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .appointments-today h3, .appointments-selected-day h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .appointment-item:hover {
            transform: translateY(-2px);
        }
        
        .appointment-info h4 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .appointment-info p {
            color: #666;
            font-size: 14px;
        }
        
        .appointment-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .appointment-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-appointment-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
        }
        .edit-appointment-btn:hover {
            color: #667eea;
        }

        .status-confirmed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-header h2 {
            color: #667eea;
            font-size: 24px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .calendar-nav button:hover { transform: scale(1.05); }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-days div {
            text-align: center;
            padding: 8px;
            font-weight: bold;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .calendar-date {
            text-align: center;
            padding: 15px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            position: relative;
        }

        .calendar-date:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .calendar-date.other-month { opacity: 0.4; }
        .calendar-date.today { background: #ff6b6b; color: white; }
        .calendar-date.selected { box-shadow: 0 0 0 3px #667eea; }

        .appointment-indicator {
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
        }
        .today .appointment-indicator { background: white; }

        .appointments-selected-day {
            margin-top: 20px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { 
            display: flex; 
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title, .modal h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #eee;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        
        .notification.show { transform: translateX(0); display: block; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }


        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .sidebar {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                padding: 15px;
            }
             .sidebar h3 { display: none; }
            .nav-item { flex-shrink: 0; }
        }
         @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
             .container { padding: 10px; }
         }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i data-lucide="scissors"></i>
                BeautyBooker
            </div>
            <div class="user-info">
                <span class="plan-badge">Piano PRO</span>
                <span>Mario Rossi - Salone Eleganza</span>
                <i data-lucide="user"></i>
            </div>
        </header>

        <main class="main-content">
            <aside class="sidebar">
                <h3>Menu Principale</h3>
                <nav id="main-nav">
                    <div class="nav-item active" data-section="dashboard">
                        <i data-lucide="home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="calendar">
                        <i data-lucide="calendar"></i>
                        <span>Calendario</span>
                    </div>
                    <div class="nav-item" data-section="clients">
                        <i data-lucide="users"></i>
                        <span>Clienti</span>
                    </div>
                    <div class="nav-item" data-section="services">
                        <i data-lucide="scissors"></i>
                         <span>Servizi</span>
                    </div>
                    <div class="nav-item" data-section="reports">
                        <i data-lucide="bar-chart"></i>
                        <span>Report</span>
                    </div>
                    <div class="nav-item" data-section="settings">
                        <i data-lucide="settings"></i>
                        <span>Impostazioni</span>
                    </div>
                </nav>
            </aside>

            <div class="content-wrapper">
                <section id="dashboard-section" class="content-section active">
                    <div class="dashboard-grid">
                        <div class="stats-card">
                            <div class="stats-number">0</div>
                            <div class="stats-label">Appuntamenti Oggi</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number">€0.00</div>
                            <div class="stats-label">Incasso Giornaliero</div>
                        </div>
                        <div class="quick-actions">
                            <h3>Azioni Rapide</h3>
                            <button id="newAppointmentBtn" class="action-btn">
                                <i data-lucide="plus"></i> Nuovo Appuntamento
                            </button>
                            <button class="action-btn" id="showNewClientModalBtn">
                                <i data-lucide="user-plus"></i> Nuovo Cliente
                            </button>
                        </div>
                    </div>
                    <div class="appointments-today">
                        <h3>Appuntamenti di Oggi</h3>
                        <div id="appointments-list"></div>
                    </div>
                </section>
    
                <section id="calendar-section" class="content-section">
                    <div class="calendar-header">
                        <h2 id="currentMonthYear"></h2>
                        <div class="calendar-nav">
                            <button id="prevMonthBtn"><i data-lucide="chevron-left"></i></button>
                            <button id="nextMonthBtn"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid calendar-days">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
                    </div>
                    <div class="calendar-grid" id="calendar-dates"></div>
                    <div class="appointments-selected-day">
                        <h3 id="selectedDayAppointmentsTitle">Appuntamenti del Giorno Selezionato</h3>
                        <div id="selectedDayAppointmentsList">
                            <p>Clicca su un giorno nel calendario per vedere gli appuntamenti.</p>
                        </div>
                    </div>
                </section>
    
                <section id="clients-section" class="content-section">
                    <h2>Clienti Recenti</h2>
                    <div id="clients-list"></div>
                </section>
    
                <section id="services-section" class="content-section">
                    <h2>Gestione Servizi</h2>
                     <p>Funzionalità di gestione servizi in arrivo...</p>
                </section>
    
                <section id="reports-section" class="content-section">
                    <h2>Report e Statistiche</h2>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </section>
    
                <section id="settings-section" class="content-section">
                    <h2>Impostazioni</h2>
                     <p>Funzionalità impostazioni in arrivo...</p>
                </section>
            </div>
        </main>
    </div>

    <div class="modal" id="newAppointmentModal">
        <div class="modal-content">
            <h3 class="modal-title">Nuovo Appuntamento</h3>
            <form id="appointmentForm">
                <div class="form-group">
                    <label for="clientSelect">Cliente</label>
                    <select id="clientSelect" required>
                        <option value="">Seleziona cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="serviceSelect">Servizio</label>
                    <select id="serviceSelect" required>
                        <option value="">Seleziona servizio</option>
                        <option value="Taglio e Piega">Taglio e Piega</option>
                        <option value="Piega">Piega</option>
                        <option value="Colore">Colore</option>
                        <option value="Barba e Baffi">Barba e Baffi</option>
                        <option value="Trattamento Viso">Trattamento Viso</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointmentDate">Data</label>
                    <input type="date" id="appointmentDate" required>
                </div>
                <div class="form-group">
                    <label for="appointmentTime">Ora</label>
                    <input type="time" id="appointmentTime" required>
                </div>
                <div class="form-group">
                    <label for="appointmentNotes">Note</label>
                    <textarea id="appointmentNotes" rows="3" placeholder="Note aggiuntive..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Salva Appuntamento</button>
                    <button type="button" class="btn-secondary" id="cancelAppointmentBtn">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="newClientModal">
        <div class="modal-content">
            <h3>Nuovo Cliente</h3>
            <form id="clientForm">
                <div class="form-group">
                    <label for="clientName">Nome</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label for="clientSurname">Cognome</label>
                    <input type="text" id="clientSurname" required>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Telefono</label>
                    <input type="tel" id="clientPhone" required>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail">
                </div>
                <div class="form-group">
                    <label for="clientNotes">Note</label>
                    <textarea id="clientNotes" rows="3" placeholder="Preferenze, allergie, note..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Salva Cliente</button>
                    <button type="button" class="btn-secondary" id="cancelClientBtn">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM ELEMENT SELECTIONS ---
            const newAppointmentModal = document.getElementById('newAppointmentModal');
            const newClientModal = document.getElementById('newClientModal');
            const appointmentForm = document.getElementById('appointmentForm');
            const clientForm = document.getElementById('clientForm');
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const clientSelect = document.getElementById('clientSelect');
            const serviceSelect = document.getElementById('serviceSelect');
            const appointmentDateInput = document.getElementById('appointmentDate');
            const appointmentTimeInput = document.getElementById('appointmentTime');
            const appointmentNotesInput = document.getElementById('appointmentNotes');

            const clientNameInput = document.getElementById('clientName');
            const clientSurnameInput = document.getElementById('clientSurname');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientEmailInput = document.getElementById('clientEmail');
            const clientNotesInput = document.getElementById('clientNotes');

            const appointmentsList = document.getElementById('appointments-list');
            const clientsList = document.getElementById('clients-list');
            const calendarDatesContainer = document.getElementById('calendar-dates');
            const currentMonthYearHeader = document.getElementById('currentMonthYear');

            const todayAppointmentsCount = document.querySelector('#dashboard-section .stats-number');
            const todayRevenueAmount = document.querySelectorAll('#dashboard-section .stats-number')[1];

            const selectedDayAppointmentsTitle = document.getElementById('selectedDayAppointmentsTitle');
            const selectedDayAppointmentsList = document.getElementById('selectedDayAppointmentsList');

            const revenueChartCanvas = document.getElementById('revenueChart');
            let revenueChartInstance = null;

            // Buttons
            const newAppointmentBtn = document.getElementById('newAppointmentBtn');
            const cancelAppointmentBtn = document.getElementById('cancelAppointmentBtn');
            const showNewClientModalBtn = document.getElementById('showNewClientModalBtn');
            const cancelClientBtn = document.getElementById('cancelClientBtn');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');

            const contentSections = document.querySelectorAll('.content-section');
            const navItems = document.querySelectorAll('#main-nav .nav-item');

            // --- APPLICATION STATE (STATIC DATA) ---
            const state = {
                appointments: [
                    { id: 1, client_id: 1, service: 'Taglio e Piega', appointment_date: '2025-07-26', appointment_time: '09:00', status: 'Confermato', notes: 'Primo appuntamento', name: 'Maria', surname: 'Bianchi', price: 45 },
                    { id: 2, client_id: 2, service: 'Barba e Baffi', appointment_date: '2025-07-26', appointment_time: '10:30', status: 'In attesa', notes: '', name: 'Luigi', surname: 'Verdi', price: 15 },
                    { id: 3, client_id: 3, service: 'Colore', appointment_date: '2025-07-28', appointment_time: '14:00', status: 'Confermato', notes: '', name: 'Anna', surname: 'Neri', price: 60 },
                ],
                clients: [
                    { id: 1, name: 'Maria', surname: 'Bianchi', phone: '3331234567'},
                    { id: 2, name: 'Luigi', surname: 'Verdi', phone: '3339876543'},
                    { id: 3, name: 'Anna', surname: 'Neri', phone: '3335555555'}
                ],
                currentCalendarDate: new Date(),
                activeSection: 'dashboard',
                editingAppointment: null
            };

            // --- API-LIKE FUNCTIONS (using static data) ---

            const fetchClients = async () => {
                // Simula una chiamata API
                renderClients();
                populateClientSelect();
            };

            const fetchAppointments = async () => {
                // Simula una chiamata API
                renderAppointments();
                renderCalendar();
                renderAppointmentsForSelectedDay(null);
            };
            
            const fetchDashboardData = async () => {
                const todayString = new Date().toISOString().split('T')[0];
                const todayAppointments = state.appointments.filter(app => app.appointment_date === todayString);
                
                if (todayAppointmentsCount) {
                    todayAppointmentsCount.textContent = todayAppointments.length;
                }

                const revenue = todayAppointments.reduce((acc, curr) => acc + (curr.price || 0), 0);
                if (todayRevenueAmount) {
                    todayRevenueAmount.textContent = `€${revenue.toFixed(2)}`;
                }
            };
            
            const fetchRevenueData = async () => {
                // Simula dati per il grafico
                const monthlyRevenueData = [
                    { month: 'Febbraio', revenue: 2500 }, { month: 'Marzo', revenue: 3200 },
                    { month: 'Aprile', revenue: 2800 }, { month: 'Maggio', revenue: 4100 },
                    { month: 'Giugno', revenue: 3800 }, { month: 'Luglio', revenue: 4500 }
                ];
                const monthlyAppointmentsData = [
                    { month: 'Febbraio', count: 50 }, { month: 'Marzo', count: 65 },
                    { month: 'Aprile', count: 58 }, { month: 'Maggio', count: 80 },
                    { month: 'Giugno', count: 75 }, { month: 'Luglio', count: 90 }
                ];
                renderRevenueChart(monthlyRevenueData, monthlyAppointmentsData);
            };

            // --- RENDERING FUNCTIONS ---

            const populateClientSelect = () => {
                if (!clientSelect) return;
                clientSelect.innerHTML = '<option value="">Seleziona cliente</option>';
                state.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name || ''} ${client.surname || ''}`.trim();
                    clientSelect.appendChild(option);
                });
            };

            const renderAppointments = () => {
                if (!appointmentsList) return;
                appointmentsList.innerHTML = '';
                const todayString = new Date().toISOString().split('T')[0];
                const todayAppointments = state.appointments.filter(app => app.appointment_date === todayString);

                if (todayAppointments.length === 0) {
                    appointmentsList.innerHTML = '<p>Nessun appuntamento per oggi.</p>';
                    return;
                }
                
                todayAppointments.sort((a,b) => a.appointment_time.localeCompare(b.appointment_time));

                todayAppointments.forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'appointment-item';
                    const statusClass = `status-${app.status ? app.status.toLowerCase().replace(/\s/g, '-') : 'sconosciuto'}`;
                    const clientName = `${app.name || 'N/A'} ${app.surname || 'N/A'}`.trim();

                    item.innerHTML = `
                        <div class="appointment-info">
                            <h4>${clientName}</h4>
                            <p>${app.appointment_time || 'N/A'} - ${app.service || 'N/A'}</p>
                        </div>
                        <span class="appointment-status ${statusClass}">${app.status || 'Sconosciuto'}</span>
                    `;
                    appointmentsList.appendChild(item);
                });
            };

            const renderClients = () => {
                if (!clientsList) return;
                clientsList.innerHTML = '';
                const sortedClients = [...state.clients].sort((a, b) => b.id - a.id);

                if (sortedClients.length === 0) {
                    clientsList.innerHTML = '<p>Nessun cliente recente.</p>';
                    return;
                }

                sortedClients.forEach(client => {
                    const item = document.createElement('div');
                    item.className = 'appointment-item'; // Re-using style
                    const initials = client.name && client.surname ? `${client.name[0]}${client.surname[0]}`.toUpperCase() : '??';
                    item.innerHTML = `
                        <div class="client-avatar" style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">${initials}</div>
                        <div class="client-info">
                            <h4>${client.name || 'N/A'} ${client.surname || 'N/A'}</h4>
                            <p>${client.phone || 'N/A'}</p>
                        </div>
                    `;
                    clientsList.appendChild(item);
                });
            };

            const renderCalendar = () => {
                if (!calendarDatesContainer || !currentMonthYearHeader) return;

                calendarDatesContainer.innerHTML = '';
                const year = state.currentCalendarDate.getFullYear();
                const month = state.currentCalendarDate.getMonth();

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();

                let startDayOfWeek = firstDayOfMonth.getDay();
                startDayOfWeek = (startDayOfWeek === 0) ? 6 : startDayOfWeek - 1;

                for (let i = 0; i < startDayOfWeek; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.classList.add('calendar-date', 'empty');
                    calendarDatesContainer.appendChild(emptyDiv);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateString = date.toISOString().split('T')[0];

                    const hasAppointments = state.appointments.some(app => app.appointment_date === dateString);
                    const isToday = dateString === new Date().toISOString().split('T')[0];

                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'calendar-date';
                    dateDiv.textContent = day;
                    dateDiv.dataset.date = dateString;

                    if (hasAppointments) {
                        const indicator = document.createElement('div');
                        indicator.className = 'appointment-indicator';
                        dateDiv.appendChild(indicator);
                    }
                    if (isToday) {
                        dateDiv.classList.add('today');
                    }

                    dateDiv.addEventListener('click', () => {
                        renderAppointmentsForSelectedDay(dateString);
                        document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                        dateDiv.classList.add('selected');
                    });
                    
                    calendarDatesContainer.appendChild(dateDiv);
                }

                currentMonthYearHeader.textContent = state.currentCalendarDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            };

            const renderAppointmentsForSelectedDay = (dateString) => {
                if (!selectedDayAppointmentsList || !selectedDayAppointmentsTitle) return;

                selectedDayAppointmentsList.innerHTML = '';

                if (!dateString) {
                    selectedDayAppointmentsTitle.textContent = 'Appuntamenti del Giorno Selezionato';
                    selectedDayAppointmentsList.innerHTML = '<p>Clicca su un giorno nel calendario per vedere gli appuntamenti.</p>';
                    return;
                }

                const selectedDate = new Date(dateString + 'T00:00:00');
                const formattedDate = selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
                selectedDayAppointmentsTitle.textContent = `Appuntamenti per ${formattedDate}`;

                const appointmentsForDay = state.appointments.filter(app => app.appointment_date === dateString);
                
                appointmentsForDay.sort((a,b) => a.appointment_time.localeCompare(b.appointment_time));

                if (appointmentsForDay.length === 0) {
                    selectedDayAppointmentsList.innerHTML = `<p>Nessun appuntamento per il ${formattedDate}.</p>`;
                    return;
                }

                appointmentsForDay.forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'appointment-item';
                    const statusClass = `status-${app.status ? app.status.toLowerCase().replace(/\s/g, '-') : 'sconosciuto'}`;
                    const clientName = `${app.name || 'N/A'} ${app.surname || 'N/A'}`.trim();

                    item.innerHTML = `
                        <div class="appointment-info">
                            <h4>${clientName}</h4>
                            <p>${app.appointment_time || 'N/A'} - ${app.service || 'N/A'}</p>
                            ${app.notes ? `<p class="appointment-notes" style="font-size: 0.8em; color: #666; font-style: italic;">Note: ${app.notes}</p>` : ''}
                        </div>
                        <div class="appointment-actions">
                            <span class="appointment-status ${statusClass}">${app.status || 'Sconosciuto'}</span>
                            <button class="edit-appointment-btn" data-appointment-id="${app.id}" title="Modifica appuntamento">
                                <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    `;
                    selectedDayAppointmentsList.appendChild(item);
                });

                selectedDayAppointmentsList.querySelectorAll('.edit-appointment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const appointmentId = parseInt(e.currentTarget.dataset.appointmentId, 10);
                        editAppointment(appointmentId);
                    });
                });
                
                lucide.createIcons();
            };
            
            const renderRevenueChart = (monthlyRevenueData, monthlyAppointmentsData) => {
                if (!revenueChartCanvas) return;
                const ctx = revenueChartCanvas.getContext('2d');
                if (revenueChartInstance) revenueChartInstance.destroy();

                const labels = monthlyRevenueData.map(d => d.month);
                
                revenueChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Incasso Mensile',
                                data: monthlyRevenueData.map(d => d.revenue),
                                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                yAxisID: 'y',
                            },
                            {
                                label: 'Appuntamenti Mensili',
                                data: monthlyAppointmentsData.map(d => d.count),
                                type: 'line',
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.3,
                                yAxisID: 'y1',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Incasso (€)' } },
                            y1: { position: 'right', title: { display: true, text: 'N° Appuntamenti' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            };

            const showSection = (sectionId) => {
                contentSections.forEach(section => section.classList.remove('active'));
                const targetSection = document.getElementById(`${sectionId}-section`);
                if (targetSection) {
                    targetSection.classList.add('active');
                    state.activeSection = sectionId;
                    if (sectionId === 'reports') fetchRevenueData();
                }
                navItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            };

            // --- UTILITY FUNCTIONS ---

            const showModal = (modalElement) => {
                if (modalElement) {
                    modalElement.classList.add('show');
                    document.body.classList.add('modal-open');
                }
            };

            const hideModal = (modalElement) => {
                if (modalElement) {
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                }
            };

            const showNotification = (message, type = 'success', duration = 3000) => {
                if (!notification || !notificationText) return;
                notificationText.textContent = message;
                notification.className = 'notification';
                notification.classList.add('show', type);
                setTimeout(() => notification.classList.remove('show'), duration);
            };

            const editAppointment = (appointmentId) => {
                const appointment = state.appointments.find(app => app.id === appointmentId);
                if (!appointment) {
                    showNotification('Appuntamento non trovato', 'error');
                    return;
                }
                state.editingAppointment = appointment;
                if (clientSelect) clientSelect.value = appointment.client_id;
                if (serviceSelect) serviceSelect.value = appointment.service;
                if (appointmentDateInput) appointmentDateInput.value = appointment.appointment_date;
                if (appointmentTimeInput) appointmentTimeInput.value = appointment.appointment_time;
                if (appointmentNotesInput) appointmentNotesInput.value = appointment.notes || '';
                const modalTitle = newAppointmentModal.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = 'Modifica Appuntamento';
                const submitBtn = appointmentForm.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Aggiorna Appuntamento';
                showModal(newAppointmentModal);
            };

            const resetAppointmentModal = () => {
                state.editingAppointment = null;
                const modalTitle = newAppointmentModal.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = 'Nuovo Appuntamento';
                const submitBtn = appointmentForm.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Salva Appuntamento';
                appointmentForm.reset();
            };

            // --- EVENT HANDLERS ---

            const handleAppointmentSubmit = async (e) => {
                e.preventDefault();
                if (!clientSelect.value || !serviceSelect.value || !appointmentDateInput.value || !appointmentTimeInput.value) {
                    showNotification('Per favore, compila tutti i campi obbligatori.', 'error');
                    return;
                }
                const selectedClient = state.clients.find(c => c.id === parseInt(clientSelect.value, 10));
                
                const data = {
                    client_id: parseInt(clientSelect.value, 10),
                    service: serviceSelect.value,
                    appointment_date: appointmentDateInput.value,
                    appointment_time: appointmentTimeInput.value,
                    notes: appointmentNotesInput.value || '',
                    status: 'Confermato', // Default status
                    name: selectedClient.name,
                    surname: selectedClient.surname
                };
                
                try {
                    let successMessage;
                    if (state.editingAppointment) {
                        const index = state.appointments.findIndex(app => app.id === state.editingAppointment.id);
                        if (index !== -1) {
                           state.appointments[index] = { ...state.editingAppointment, ...data };
                        }
                        successMessage = 'Appuntamento aggiornato con successo!';
                    } else {
                        data.id = Math.max(...state.appointments.map(a => a.id), 0) + 1;
                        state.appointments.push(data);
                        successMessage = 'Appuntamento creato con successo!';
                    }
                    showNotification(successMessage);
                    hideModal(newAppointmentModal);
                    resetAppointmentModal();
                    await fetchAppointments();
                    await fetchDashboardData();
                    if (state.activeSection === 'reports') await fetchRevenueData();
                } catch (error) {
                    const action = state.editingAppointment ? 'aggiornamento' : 'salvataggio';
                    showNotification(`Errore nel ${action}: ${error.message}`, 'error');
                }
            };

            const handleClientSubmit = async (e) => {
                e.preventDefault();
                if (!clientNameInput.value || !clientSurnameInput.value || !clientPhoneInput.value) {
                    showNotification('Compila nome, cognome e telefono.', 'error');
                    return;
                }
                const data = {
                    id: Math.max(...state.clients.map(c => c.id), 0) + 1,
                    name: clientNameInput.value,
                    surname: clientSurnameInput.value,
                    phone: clientPhoneInput.value,
                    email: clientEmailInput.value || '',
                    notes: clientNotesInput.value || ''
                };
                try {
                    state.clients.push(data);
                    showNotification('Cliente aggiunto con successo!');
                    hideModal(newClientModal);
                    clientForm.reset();
                    await fetchClients();
                } catch (error) {
                    showNotification(`Errore nel salvataggio: ${error.message}`, 'error');
                }
            };

            // --- INITIALIZATION ---
            const init = async () => {
                lucide.createIcons();

                await fetchClients();
                await fetchAppointments();
                await fetchDashboardData();

                if (newAppointmentBtn) {
                    newAppointmentBtn.addEventListener('click', () => {
                        resetAppointmentModal();
                        const today = new Date().toISOString().split('T')[0];
                        if (appointmentDateInput) appointmentDateInput.value = today;
                        showModal(newAppointmentModal);
                    });
                }
                if (showNewClientModalBtn) showNewClientModalBtn.addEventListener('click', () => showModal(newClientModal));
                if (cancelAppointmentBtn) cancelAppointmentBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideModal(newAppointmentModal);
                    resetAppointmentModal();
                });
                if (cancelClientBtn) cancelClientBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideModal(newClientModal);
                    clientForm.reset();
                });
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            hideModal(modal);
                            if (modal === newAppointmentModal) resetAppointmentModal();
                        }
                    });
                });
                if (appointmentForm) appointmentForm.addEventListener('submit', handleAppointmentSubmit);
                if (clientForm) clientForm.addEventListener('submit', handleClientSubmit);
                if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
                    state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() - 1);
                    renderCalendar();
                });
                if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
                    state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + 1);
                    renderCalendar();
                });
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const sectionToActivate = this.dataset.section;
                        showSection(sectionToActivate);
                    });
                });
                showSection(state.activeSection);
            };

            init();
        });
    </script>
</body>
</html>
